generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  displayName  String    @map("display_name")
  credits      Int       @default(10000)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  purchases Purchase[]
  returns   Return[]

  @@index([email])
  @@index([displayName])
  @@map("users")
}

model Cosmetic {
  id         String   @id @default(uuid())
  externalId String   @unique @map("external_id")
  name       String
  type       String
  rarity     String
  imageUrl   String   @map("image_url")
  addedAt    DateTime @map("added_at")

  isNew        Boolean  @default(false) @map("is_new")
  isAvailable  Boolean  @default(false) @map("is_available")

  basePrice    Int?   @map("base_price")
  currentPrice Int?   @map("current_price")

  isBundle  Boolean  @default(false) @map("is_bundle")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  purchases    Purchase[]
  returns      Return[]
  
  bundleItems  BundleItem[]

  @@index([name])
  @@index([type])
  @@index([rarity])
  @@index([addedAt(sort: Desc)])
  @@index([isNew])
  @@index([isAvailable])
  @@index([isBundle])
  @@index([type, rarity])
  @@index([isAvailable, currentPrice])
  @@index([externalId])
  @@map("cosmetics")
}

model Bundle {
  id          String      @id @default(uuid())
  externalId  String      @unique @map("external_id")
  name        String      @map("name")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  items       BundleItem[]

  @@map("bundles")
  @@index([name])
}


model BundleItem {
  id           String    @id @default(uuid())
  bundleId     String    @map("bundle_id")
  itemId       String    @map("item_id")
  description  String    @map("description")

  bundle       Bundle    @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  item         Cosmetic  @relation(fields: [itemId], references: [id], onDelete: Cascade)

  createdAt    DateTime  @default(now()) @map("created_at")

  @@unique([bundleId, itemId])
  @@index([bundleId])
  @@index([itemId])
  @@map("bundle_items")
}

model Purchase {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  cosmeticId String   @map("cosmetic_id")
  price      Int

  isFromBundle     Boolean  @default(false) @map("is_from_bundle")
  parentPurchaseId String?  @map("parent_purchase_id")

  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cosmetic Cosmetic @relation(fields: [cosmeticId], references: [id], onDelete: Restrict)

  parentPurchase Purchase?  @relation("BundlePurchase", fields: [parentPurchaseId], references: [id], onDelete: Cascade)
  childPurchases Purchase[] @relation("BundlePurchase")

  @@unique([userId, cosmeticId])
  @@index([userId])
  @@index([cosmeticId])
  @@index([createdAt(sort: Desc)])
  @@index([parentPurchaseId])
  @@map("purchases")
}

model Return {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  cosmeticId String   @map("cosmetic_id")
  refunded   Int

  isBundle   Boolean  @default(false) @map("is_bundle")

  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cosmetic Cosmetic @relation(fields: [cosmeticId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([cosmeticId])
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("returns")
}

model SyncLog {
  id        String   @id @default(uuid())
  job       String
  status    String
  message   String?

  itemsProcessed Int?     @map("items_processed")
  itemsCreated   Int?     @map("items_created")
  itemsUpdated   Int?     @map("items_updated")
  duration       Int?

  startedAt  DateTime? @map("started_at")
  finishedAt DateTime? @map("finished_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@index([job])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([job, status, createdAt(sort: Desc)])
  @@map("sync_logs")
}

model IdempotencyKey {
  id        String   @id @default(uuid())
  key       String   @unique
  userId    String   @map("user_id")
  endpoint  String
  response  Json
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([key])
  @@index([userId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}